<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Post | Harihar Car Carriers</title>
  <base href="./" />
  <link rel="icon" type="image/png" href="../assets/icons/favicon.png" />

  <link rel="stylesheet" href="../css/components/navbar.css" />
  <link rel="stylesheet" href="../css/components/middle-navbar.css" />
  <link rel="stylesheet" href="../css/components/loading-indicators.css" />
  <link rel="stylesheet" href="../css/styles.css" />
  <link rel="stylesheet" href="../css/components/floating-call-button.css" />
  <link rel="stylesheet" href="../css/components/floating-whatsapp-button.css" />
  <link rel="stylesheet" href="../css/components/floating-chatbot-button.css" />
  <link rel="stylesheet" href="../css/components/sticky-quote-button.css" />
  <link rel="stylesheet" href="../css/components/quote-modal.css" />
  <link rel="stylesheet" href="../css/components/chatbot-modal.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/components/floating-button.css" />
  <link rel="stylesheet" href="../css/components/glowing-input.css" />
  <link rel="stylesheet" href="../css/pages/blog-post.css" />
</head>

<body class="blog-post-page">
  <div id="navbar-container"></div>

  <div class="reading-progress" id="readingProgress"></div>

  <main class="post-page">
    <aside class="toc-sidebar" id="tocSidebar">
      <button class="toc-toggle" id="tocToggle">
        <i class="fas fa-list"></i>
        <span>Contents</span>
      </button>
      <h3 class="toc-title"><i class="fas fa-list"></i> Contents</h3>
      <ul class="toc-list" id="tocList"></ul>
    </aside>

    <article class="post-article" id="post-article">
      <div class="post-meta">
        <h1 id="post-title">Loading...</h1>
        <div class="meta-row">
          <span class="meta-item">
            <i class="fas fa-calendar-alt"></i>
            <time id="post-date"></time>
          </span>
          <span class="meta-item read-time-badge">
            <i class="fas fa-clock"></i>
            <span id="post-readtime"></span>
          </span>
          <span class="meta-item">
            <i class="fas fa-eye"></i>
            <span id="post-views"></span> views
          </span>
        </div>
      </div>

      <figure class="post-figure">
        <img id="post-image" alt="Post image" loading="lazy" />
      </figure>

      <section id="post-body" class="post-body">
        <p>Loading post...</p>
      </section>

      <div class="post-actions">
        <a href="blog.html" class="btn ghost">
          <i class="fas fa-arrow-left"></i> Back to Blog
        </a>
        <a href="contact.html" class="btn primary">
          <i class="fas fa-quote-left"></i> Get a Quote
        </a>
        <div class="clap-container">
          <button id="clapBtn" class="clap-btn" aria-label="Clap for this post">
            <i class="fas fa-hands-clapping"></i>
            <span id="clapCount" class="clap-count"></span>
            <div id="particlesContainer" class="particles-container"></div>
          </button>
        </div>
      </div>

      <section class="related-posts" id="relatedPosts">
        <h2 class="related-posts-title">
          <i class="fas fa-newspaper"></i> Related Articles
        </h2>
        <div class="related-grid" id="relatedGrid"></div>
      </section>
    </article>
  </main>

  <aside class="share-sidebar" id="shareSidebar">
    <button class="share-btn toggle" id="shareToggle" title="Share">
      <i class="fas fa-share-alt"></i>
    </button>
    <div class="share-hint" id="shareHint">Click to share</div>
    <div class="share-options" id="shareOptions">
      <a href="#" class="share-btn facebook" id="shareFacebook" title="Share on Facebook">
        <i class="fab fa-facebook-f"></i>
      </a>
      <a href="#" class="share-btn twitter" id="shareTwitter" title="Share on Twitter">
        <i class="fab fa-twitter"></i>
      </a>
      <a href="#" class="share-btn linkedin" id="shareLinkedin" title="Share on LinkedIn">
        <i class="fab fa-linkedin-in"></i>
      </a>
      <a href="#" class="share-btn whatsapp" id="shareWhatsapp" title="Share on WhatsApp">
        <i class="fab fa-whatsapp"></i>
      </a>
      <a href="#" class="share-btn email" id="shareEmail" title="Share via Email">
        <i class="fas fa-envelope"></i>
      </a>
      <button class="share-btn copy" id="copyLink" title="Copy link">
        <i class="fas fa-link"></i>
      </button>
    </div>
  </aside>

  <div id="footer-container"></div>

  <script type="module">
    import BLOG_POSTS from "../js/data/blog-data.js";

    const id = new URLSearchParams(window.location.search).get("id");
    const post = BLOG_POSTS.find((p) => String(p.id) === String(id));

    if (!post) {
      document.getElementById("post-article").innerHTML = `
        <div class="not-found-container">
          <div class="not-found-content">
            <div class="not-found-icon">
              <i class="fas fa-search"></i>
            </div>
            <h1>Oops! Article Missing</h1>
            <p>We couldn't find the blog post you're looking for. It might have been moved or doesn't exist anymore.</p>
            <div class="not-found-actions">
              <a href="blog.html" class="btn primary glowing-btn">
                <i class="fas fa-arrow-left"></i> Back to Blog Feed
              </a>
            </div>
          </div>
        </div>
      `;
    } else {
      document.getElementById("post-title").textContent = post.title;
      document.getElementById("post-date").textContent = post.date;
      document.getElementById("post-views").textContent = post.views || 0;
      document.getElementById("post-image").src = post.image;

      const postBodyEl = document.getElementById("post-body");
      postBodyEl.innerHTML = post.contentHTML;

      // Dynamic Reading Time Calculation
      const div = document.createElement("div");
      div.innerHTML = post.contentHTML;
      const textContent = div.textContent || div.innerText || "";
      const wordsPerMinute = 200;
      const wordCount = textContent.split(/\s+/).filter(word => word.length > 0).length;
      const readingTime = Math.ceil(wordCount / wordsPerMinute);
      document.getElementById("post-readtime").textContent = `${readingTime} min read`;

      setupReadingProgress();
      setupClapSystem();
      setupTableOfContents();
      setupSocialSharing(post);
      setupRelatedPosts(post);
      setupImageAnimations();
    }

    function setupImageAnimations() {
      const images = document.querySelectorAll('.post-article img');

      images.forEach(img => {
        // If it's already complete (cached)
        if (img.complete) {
          img.classList.add('img-loaded');
        } else {
          // Hide it initially
          img.classList.add('img-loading');

          img.onload = () => {
            img.classList.add('img-loaded');
          };

          img.onerror = () => {
            img.classList.remove('img-loading');
            img.style.opacity = '1'; // Fallback
          };
        }
      });
    }

    function setupClapSystem() {
      const clapBtn = document.getElementById("clapBtn");
      const clapCount = document.getElementById("clapCount");
      const particlesContainer = document.getElementById("particlesContainer");

      if (!clapBtn || !clapCount) return;

      // Simulated initial count or from local storage
      let count = parseInt(localStorage.getItem(`claps-${id}`) || "0");
      clapCount.textContent = count > 0 ? count : "";
      if (count > 0) clapBtn.classList.add("has-claps");

      clapBtn.addEventListener("click", () => {
        count++;
        localStorage.setItem(`claps-${id}`, count);
        clapCount.textContent = count;

        // Add visual feedback classes
        clapBtn.classList.add("clicked", "has-claps");
        setTimeout(() => clapBtn.classList.remove("clicked"), 300);

        // Particle burst
        createParticles(particlesContainer);
      });
    }

    function createParticles(container) {
      const particleCount = 12;
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement("span");
        particle.className = "particle";

        // Random direction and distance
        const angle = (i / particleCount) * 360;
        const distance = 40 + Math.random() * 40;
        const size = 4 + Math.random() * 6;

        particle.style.setProperty("--angle", `${angle}deg`);
        particle.style.setProperty("--distance", `${distance}px`);
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;

        container.appendChild(particle);

        // Remove particle after animation
        particle.addEventListener("animationend", () => {
          particle.remove();
        });
      }
    }

    function setupReadingProgress() {
      const progressBar = document.getElementById("readingProgress");
      if (!progressBar) return;

      const updateProgress = () => {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight - windowHeight;
        const scrolled = window.scrollY;

        // Sync position with navbar bottom
        const navbar = document.querySelector('.navbar');
        if (navbar) {
          const rect = navbar.getBoundingClientRect();
          progressBar.style.top = `${rect.bottom}px`;
        }

        if (documentHeight > 0) {
          const progress = (scrolled / documentHeight) * 100;
          progressBar.style.width = `${Math.min(Math.max(progress, 0), 100)}%`;
        } else {
          progressBar.style.width = "0%";
        }
      };

      window.addEventListener("scroll", updateProgress);
      window.addEventListener("resize", updateProgress);
      updateProgress();
    }

    function setupTableOfContents() {
      const postBody = document.getElementById("post-body");
      const tocList = document.getElementById("tocList");
      const postPage = document.querySelector(".post-page");

      if (!postBody) {
        if (postPage) postPage.classList.add("no-toc");
        const tocSidebar = document.getElementById("tocSidebar");
        if (tocSidebar) tocSidebar.style.display = "none";
        return;
      }

      const headings = postBody.querySelectorAll("h2, h3");

      if (headings.length === 0) {
        const tocSidebar = document.getElementById("tocSidebar");
        if (tocSidebar) tocSidebar.style.display = "none";
        if (postPage) postPage.classList.add("no-toc");
        return;
      } else {
        if (postPage) postPage.classList.remove("no-toc");
        const tocSidebar = document.getElementById("tocSidebar");
        if (tocSidebar) tocSidebar.style.display = "";
      }

      headings.forEach((heading, index) => {
        heading.id = `section-${index}`;
        const li = document.createElement("li");
        li.className = "toc-item";
        li.textContent = heading.textContent;
        li.style.paddingLeft = heading.tagName === "H3" ? "20px" : "0";

        li.addEventListener("click", () => {
          heading.scrollIntoView({ behavior: "smooth", block: "start" });
        });

        tocList.appendChild(li);
      });

      window.addEventListener("scroll", () => {
        let currentSection = "";
        headings.forEach((heading) => {
          const rect = heading.getBoundingClientRect();
          if (rect.top <= 150) currentSection = heading.id;
        });

        const tocItems = document.querySelectorAll(".toc-item");
        tocItems.forEach((item, index) => {
          item.classList.toggle("active", `section-${index}` === currentSection);
        });
      });
    }

    function setupSocialSharing(post) {
      const url = encodeURIComponent(window.location.href);
      const title = encodeURIComponent(post.title);
      const text = encodeURIComponent(post.excerpt || post.title);
      const sidebar = document.getElementById("shareSidebar");
      const toggle = document.getElementById("shareToggle");
      const hint = document.getElementById("shareHint");

      document.getElementById(
        "shareFacebook"
      ).href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
      document.getElementById(
        "shareTwitter"
      ).href = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
      document.getElementById(
        "shareLinkedin"
      ).href = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
      document.getElementById(
        "shareWhatsapp"
      ).href = `https://wa.me/?text=${title}%20${url}`;
      document.getElementById(
        "shareEmail"
      ).href = `mailto:?subject=${title}&body=${text}%0A%0A${url}`;

      document
        .getElementById("copyLink")
        .addEventListener("click", (e) => {
          e.preventDefault();
          navigator.clipboard.writeText(window.location.href).then(() => {
            const btn = e.currentTarget;
            const icon = btn.querySelector("i");
            btn.classList.add("copied");
            icon.className = "fas fa-check";
            setTimeout(() => {
              btn.classList.remove("copied");
              icon.className = "fas fa-link";
            }, 2000);
          });
        });

      if (toggle && sidebar) {
        const hideHint = () => hint && hint.classList.add("hide");

        toggle.addEventListener("click", (e) => {
          e.preventDefault();
          sidebar.classList.toggle("open");
          hideHint();
        });

        setTimeout(hideHint, 4000);

        document.addEventListener("click", (e) => {
          if (!sidebar.contains(e.target)) {
            sidebar.classList.remove("open");
          }
        });
      }
    }

    function setupRelatedPosts(currentPost) {
      const relatedGrid = document.getElementById("relatedGrid");
      const related = BLOG_POSTS.filter((p) => p.id !== currentPost.id)
        .filter((p) => {
          if (!currentPost.category && !currentPost.tags) return true;
          return (
            p.category === currentPost.category ||
            (currentPost.tags &&
              p.tags &&
              p.tags.some((tag) => currentPost.tags.includes(tag)))
          );
        })
        .slice(0, 3);

      if (related.length === 0) {
        document.getElementById("relatedPosts").style.display = "none";
        return;
      }

      relatedGrid.innerHTML = related
        .map(
          (post) => `
        <a href="blog-post.html?id=${post.id}" class="related-card">
          <img src="${post.image}" alt="${post.title}" loading="lazy">
          <div class="related-card-body">
            <h3 class="related-card-title">${post.title}</h3>
            <p class="related-card-meta">${post.date} â€¢ ${post.readtime}</p>
          </div>
        </a>
      `
        )
        .join("");
    }
  </script>

  <script>
    const tocToggle = document.getElementById("tocToggle");
    const tocSidebar = document.getElementById("tocSidebar");

    if (tocToggle && tocSidebar) {
      tocToggle.addEventListener("click", () => {
        tocSidebar.classList.toggle("expanded");
      });

      document.addEventListener("click", (e) => {
        if (
          e.target.classList.contains("toc-item") &&
          window.innerWidth <= 1200
        ) {
          setTimeout(() => {
            tocSidebar.classList.remove("expanded");
          }, 300);
        }
      });
    }
  </script>

  <script src="../js/modules/search.js"></script>
  <script src="../js/modules/loading-state-manager.js"></script>
  <script src="../js/modules/page-navigation-loader.js"></script>
  <script src="../js/modules/navbar-loader.js?v=2"></script>
  <script src="../js/modules/footer-loader.js"></script>
  <script src="../js/modules/themes.js"></script>
  <script src="../js/modules/quote-modal.js"></script>
  <script src="../js/modules/sticky-quote-button.js"></script>
  <script src="../js/modules/floating-chatbot-button.js"></script>
  <script src="../js/modules/chatbot-modal.js"></script>
  <script src="../js/script.js"></script>
</body>

</html>