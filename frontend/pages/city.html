<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Car Transport Service</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    crossorigin="anonymous" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700;800&display=swap">

  <link rel="stylesheet" href="../css/components/navbar.css" />
  <link rel="stylesheet" href="../css/components/middle-navbar.css" />
  <link rel="stylesheet" href="../css/components/loading-indicators.css" />
  <link rel="stylesheet" href="../css/components/glowing-input.css" />
  <link rel="stylesheet" href="../css/styles.css">
  <link id="theme-style" rel="stylesheet" href="../css/light-mode.css" />

  <!-- ðŸŒŸ Preloader & Theme Meta-Component (Prevents FOUC) -->
  <link rel="stylesheet" href="../css/components/preloader-meta.css">
  <script src="../js/modules/preloader-meta.js"></script>
  <link rel="stylesheet" href="../css/pages/city.css">
  <!-- ðŸŽ¨ SUPER-NUCLEAR Style Overrides to kill ANY orange background -->
  <style>
    /* Targeting ALL possible containers and pseudo-elements */
    html,
    body,
    main,
    .city-page-layout,
    .city-hero,
    html::before,
    html::after,
    body::before,
    body::after,
    main::before,
    main::after {
      background: #f3f4f7 !important;
      background-color: #f3f4f7 !important;
      background-image: none !important;
    }

    body.city-page-layout[data-theme="dark"],
    body.city-page-layout[data-theme="dark"] main,
    body.city-page-layout[data-theme="dark"] .city-hero {
      background: #0a0c10 !important;
      background-color: #0a0c10 !important;
    }

    /* Force the card background and remove any inheritance */
    body.city-page-layout[data-theme="dark"] .city-glass-card {
      background: rgba(15, 18, 26, 0.9) !important;
    }

    /* Transition for city rotation */
    .city-details,
    .city-image-container {
      transition: opacity 0.4s ease-in-out;
    }

    .rotating {
      opacity: 0;
    }
  </style>

  <script src="../js/modules/themes.js"></script>
</head>

<body class="city-page-layout neon-theme">
  <div id="scroll-progress"></div>
  <div id="navbar-container"></div>

  <main class="city-hero">
    <div id="city-card" class="city-glass-card no-image">
      <div class="city-image-container">
        <div class="image-overlay"></div>
        <img id="cityImage" src="../assets/images/cities/default.jpg" alt="City Image" class="city-img"
          onerror="handleImageError()">
      </div>

      <div class="city-details">
        <div class="city-badge">Premium Service</div>
        <h1 id="cityTitle" class="glow-text">Loading...</h1>
        <div class="city-divider"></div>
        <p id="cityDescription" class="city-desc">
          Picking the best service route for you...
        </p>

        <div class="city-features">
          <div class="feature-item">
            <i class="fas fa-shield-alt"></i>
            <span>Fully Insured</span>
          </div>
          <div class="feature-item">
            <i class="fas fa-truck"></i>
            <span>Doorstep Delivery</span>
          </div>
          <div class="feature-item">
            <i class="fas fa-clock"></i>
            <span>24/7 Tracking</span>
          </div>
        </div>

        <div class="city-actions">
          <button class="cta-primary-btn" id="getQuoteBtnHeader">
            <i class="fas fa-file-invoice-dollar"></i>
            Get Free Quote
          </button>
          <button class="cta-secondary-btn" id="bookNowBtnHeader">
            <i class="fas fa-calendar-check"></i>
            Book Now
          </button>
        </div>
      </div>
    </div>
  </main>

  <div id="footer-container"></div>

  <script>
    let allCities = [];
    let currentRotationIndex = 0;
    let rotationInterval;

    // --- Action Button Handlers ---
    const getQuoteBtn = document.getElementById('getQuoteBtnHeader');
    const bookNowBtn = document.getElementById('bookNowBtnHeader');

    if (getQuoteBtn) {
      getQuoteBtn.addEventListener('click', () => {
        window.location.href = './pricing-calculator.html';
      });
    }

    if (bookNowBtn) {
      bookNowBtn.addEventListener('click', () => {
        // citySlug is no longer used for booking URL, as rotation is primary
        window.location.href = `./booking.html`;
      });
    }

    async function initializeCityPage() {
      try {
        const response = await fetch('../assets/data/cities.json');
        allCities = await response.json();

        // Get city from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const citySlug = urlParams.get('city');

        let cityToDisplay = allCities[0]; // Default to first city

        if (citySlug) {
          const foundCity = allCities.find(c => c.slug === citySlug);
          if (foundCity) {
            cityToDisplay = foundCity;
          }
        }

        // Display the city once and stop
        updateCityPage(cityToDisplay);
      } catch (error) {
        console.error('Initialization error:', error);
        showGeneralError();
      }
    }

    function updateCityPage(data) {
      if (!data) return;
      document.title = data.name + " | Car Transport Service";
      document.getElementById('cityTitle').textContent = data.name;
      document.getElementById('cityDescription').textContent = data.description;

      const imgEl = document.getElementById('cityImage');
      const cardEl = document.getElementById('city-card');

      if (!imgEl) return;

      // Priority 1: High-Res External URL
      if (data.external_url) {
        imgEl.style.display = 'block';
        imgEl.src = data.external_url;
        cardEl.classList.remove('no-image');

        // Priority 2: Local Specific Landmark (Fallback)
        // Priority 3: Regional Master (Final Fallback)
        imgEl.onerror = () => {
          imgEl.src = data.image.startsWith('/') ? `..${data.image}` : data.image;
          imgEl.onerror = () => {
            const region = data.region || 'north';
            imgEl.src = `../assets/images/fallbacks/${region}-india.jpg`;
            imgEl.onerror = () => {
              handleImageError();
            };
          };
        };
      } else if (data.image) {
        imgEl.style.display = 'block';
        imgEl.src = data.image.startsWith('/') ? `..${data.image}` : data.image;
        cardEl.classList.remove('no-image');
        imgEl.onerror = () => {
          const region = data.region || 'north';
          imgEl.src = `../assets/images/fallbacks/${region}-india.jpg`;
          imgEl.onerror = () => handleImageError();
        };
      } else {
        handleImageError();
      }
    }

    function handleImageError() {
      const imgEl = document.getElementById('cityImage');
      const cardEl = document.getElementById('city-card');
      cardEl.classList.add('no-image');
      if (imgEl) imgEl.style.display = 'none';
    }

    function showGeneralError() {
      document.getElementById("cityTitle").textContent = "Service Available";
      document.getElementById("cityDescription").textContent = "We serve all of India! Choose your city or get a quote now.";
      handleImageError();
    }

    // Start everything
    initializeCityPage();
  </script>

  <!-- ðŸŒŸ Bottom Fixed Action Bar -->
  <link rel="stylesheet" href="../css/components/footer.css" />
  <link rel="stylesheet" href="../css/components/sticky-quote-button.css" />
  <link rel="stylesheet" href="../css/components/quote-modal.css" />
  <link rel="stylesheet" href="../css/components/bottom-fixed-container.css" />

  <script src="../js/modules/navbar-loader.js?v=2"></script>
  <script src="../js/modules/modal.js"></script>
  <script src="../js/modules/quote-modal.js"></script>
  <script src="../js/modules/footer-loader.js"></script>
  <script src="../js/modules/themes.js"></script>
  <!-- Component Initializer - Ensures global components (FAB, Chatbot, etc.) are available -->
  <script src="../js/modules/component-initializer.js"></script>
</body>

</html>